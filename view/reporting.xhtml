<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:s="http://jboss.com/products/seam/taglib"
				xmlns:ui="http://java.sun.com/jsf/facelets" 
				xmlns:f="http://java.sun.com/jsf/core"
				xmlns:c="http://java.sun.com/jstl/core" 
				xmlns:h="http://java.sun.com/jsf/html"
				xmlns:rich="http://richfaces.org/rich"
				xmlns:a="http://richfaces.org/a4j"
				template="layout/template.xhtml">

<ui:define name="title">Reporting</ui:define>

	<ui:define name="data-main-title">Reporting by #{type == null ? 'year' : type}</ui:define>
	<ui:define name="data-main-body">
		<rich:panel>
			<f:facet name="header">Reporting</f:facet>
			<h:form>
				<rich:simpleTogglePanel switchType="client" label="Filter" opened="#{reportingFilter.useFilterFixed}">

					<s:decorate id="startPeriodField" template="layout/edit.xhtml">
						<ui:define name="label">Start period</ui:define>
						<h:selectOneMenu id="startPeriod" value="#{reportingFilter.startPeriod}" converter="periodConverter">
							<s:selectItems var="p" value="#{reportingFilter.getAvailablePeriods(type)}" label="#{p}" noSelectionLabel="[Select]" />
						</h:selectOneMenu>
					</s:decorate>

					<s:decorate id="endPeriodField" template="layout/edit.xhtml">
						<ui:define name="label">End period</ui:define>
						<h:selectOneMenu id="endPeriod" value="#{reportingFilter.endPeriod}" converter="periodConverter">
							<s:selectItems var="p" value="#{reportingFilter.getAvailablePeriods(type)}" label="#{p}" noSelectionLabel="[Select]" />
							<s:validateEquality for="startPeriod" required="false" operator="greater_or_equal" messageId="validation.end.period" />
						</h:selectOneMenu>
					</s:decorate>

					<s:decorate id="employeesField" template="layout/edit.xhtml">
						<ui:define name="label">Employees</ui:define>
						<h:selectManyListbox value="#{reportingFilter.users}" size="5">
							<s:selectItems value="#{userList.resultList}" var="u" label="#{u.fullName}" />
							<s:convertEntity />
						</h:selectManyListbox>
					</s:decorate>

					<s:decorate id="expenseTypesField" template="layout/edit.xhtml">
						<ui:define name="label">Columns</ui:define>
						<h:selectManyListbox value="#{reportingFilter.expenseTypes}" size="5">
							<s:selectItems value="#{expenseTypeList.resultList}" var="et" label="#{messages[et.nameKey]}" />
							<s:convertEntity />
						</h:selectManyListbox>
					</s:decorate>

					<div style="clear: both" />

					<div class="actionButtons">
						<h:commandButton value="Filter" action="#{reportingFilter.turnOn()}">
							<s:conversationPropagation type="join" />
						</h:commandButton>
					
						<s:button value="Clear Filter" action="#{reportingFilter.clear()}" />
					</div>

				</rich:simpleTogglePanel>
			</h:form>

			<rich:spacer height="10" />

			<h:outputText value="No results have been found." rendered="#{empty currentReporting.subReportingsKeys}" />

			<rich:dataTable id="reportingTable" var="_subReportingKey" value="#{currentReporting.subReportingsKeys}" rendered="#{not empty currentReporting.subReportingsKeys}"
					onRowMouseOver="this.style.backgroundColor='#F1F1F1'" onRowMouseOut="this.style.backgroundColor='#{a4jSkin.tableBackgroundColor}'">
				<f:facet name="header">
					<rich:columnGroup>
						<rich:column rowspan="2">
							Employee
						</rich:column>
						<rich:columns var="categ" value="#{expenseCategoryList.resultList}" colspan="#{categ.expenseTypes.size()}" rowspan="#{categ.expenseTypes.size() eq 1 ? 2 : 1}">
							#{messages[categ.nameKey]}
								
							<rich:column rendered="#{categ.expenseTypes.size() gt 1}" rowspan="2">
								#{messages['reporting.total']}
							</rich:column>
						</rich:columns>
						
						<rich:column rowspan="2">
								#{messages['reporting.grand.total']}
						</rich:column>
							
						<c:forEach var="categ" items="#{expenseCategoryList.resultList}" varStatus="varStatus">
							<rich:columns var="categType" value="#{categ.expenseTypes}" index="tInd" id="type-column#{varStatus.index}-#{tInd}" breakBefore="#{varStatus.index eq 0 and tInd eq 0}" rendered="#{categ.expenseTypes.size() gt 1}">
								#{messages[categType.value.label]}
							</rich:columns>
						</c:forEach>
						
					</rich:columnGroup>
				</f:facet>

				<rich:column colspan="#{reportingUtils.tableColumnsSize()}" styleClass="bold centered">
					<h:outputText value="#{_subReportingKey}" />
				</rich:column>

				<rich:subTable var="_reportingRowKey" value="#{currentReporting.getSubReporting(_subReportingKey).reportingRowsKeys}"
						onRowMouseOver="this.style.backgroundColor='#F8F8F8'" onRowMouseOut="this.style.backgroundColor='#{a4jSkin.tableBackgroundColor}'">
					<rich:column>
						<h:outputText value="#{_reportingRowKey.fullName}"></h:outputText>
						<f:facet name="footer">
							<rich:spacer />
						</f:facet>
					</rich:column>
					
					<c:forEach var="categ" items="#{expenseCategoryList.resultList}" varStatus="varStatus">
						<rich:columns var="categType" value="#{categ.expenseTypes}">
							#{currentReporting.getSubReporting(_subReportingKey).getReportingRow(_reportingRowKey).getAmount(categ.code, categType.value)}
							<f:facet name="footer">
								#{currentReporting.getSubReporting(_subReportingKey).getTotalCategoryType(categ.code, categType.value)}
							</f:facet>
						</rich:columns>
						<rich:column rendered="#{categ.expenseTypes.size() gt 1}" styleClass="subTotal">
							#{currentReporting.getSubReporting(_subReportingKey).getReportingRow(_reportingRowKey).getTotalCategory(categ.code)}
							<f:facet name="footer">
								#{currentReporting.getSubReporting(_subReportingKey).getTotalCategory(categ.code)}
							</f:facet>
						</rich:column>
					</c:forEach>
					<rich:column styleClass="grandTotal">
						#{currentReporting.getSubReporting(_subReportingKey).getReportingRow(_reportingRowKey).total}
						<f:facet name="footer">
							#{currentReporting.getSubReporting(_subReportingKey).total}
						</f:facet>
					</rich:column>
				</rich:subTable>

				<f:facet name="footer">

					<rich:columnGroup>
						<rich:column>Totals</rich:column>
						<c:forEach var="categ" items="#{expenseCategoryList.resultList}" varStatus="varStatus">
							<rich:columns var="categType" value="#{categ.expenseTypes}">
								#{currentReporting.getTotalCategoryType(categ.code, categType.value)}
							</rich:columns>
							<rich:column rendered="#{categ.expenseTypes.size() gt 1}">
								#{currentReporting.getTotalCategory(categ.code)}
							</rich:column>
						</c:forEach>
						<rich:column>
							#{currentReporting.total}
						</rich:column>


						<!-- rich:column>
							<h:outputText value="#{report.expReport.totalMeals}">
								<f:convertNumber pattern="$####.00" />
							</h:outputText>
						</rich:column-->
						
					</rich:columnGroup>
				</f:facet>

			</rich:dataTable>
			
			
		</rich:panel>

		<div class="tableControl">
			<s:link view="/report-list.xhtml" rendered="#{reportList.previousExists}" value="#{messages.left}#{messages.left} First Page" id="firstPage">
				<f:param name="firstResult" value="0" />
			</s:link>
			<s:link view="/report-list.xhtml" rendered="#{reportList.previousExists}" value="#{messages.left} Previous Page" id="previousPage">
				<f:param name="firstResult" value="#{reportList.previousFirstResult}" />
			</s:link>
			<s:link view="/report-list.xhtml" rendered="#{reportList.nextExists}" value="Next Page #{messages.right}" id="nextPage">
				<f:param name="firstResult" value="#{reportList.nextFirstResult}" />
			</s:link>
			<s:link view="/report-list.xhtml" rendered="#{reportList.nextExists}" value="Last Page #{messages.right}#{messages.right}" id="lastPage">
				<f:param name="firstResult" value="#{reportList.lastFirstResult}" />
			</s:link>
		</div>

	</ui:define>
</ui:composition>
